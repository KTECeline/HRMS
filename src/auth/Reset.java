package auth;


import javax.swing.JOptionPane;
import java.io.FileReader;
import java.io.IOException;
import java.io.FileNotFoundException;
import java.util.Scanner;
import ui.dashboard.*;
import java.util.HashMap;
import java.util.Map;
import auth.Session;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.FileWriter;
import java.util.stream.Collectors;


/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */

/**
 *
 * @author Yeong Huey Yee
 */
public class Reset extends javax.swing.JFrame {

    /**
     * Creates new form LoginForm
     */
    public Reset() {
        initComponents();
        
    }
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        mainPanel = new javax.swing.JPanel();
        Header = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        hrUsername = new javax.swing.JLabel();
        hrPassword = new javax.swing.JLabel();
        txtUsername = new javax.swing.JTextField();
        btnLogin1 = new javax.swing.JButton();
        txtPassword = new javax.swing.JTextField();
        btnLogin2 = new javax.swing.JButton();
        hrUsername1 = new javax.swing.JLabel();
        txtPhone = new javax.swing.JTextField();
        hrUsername2 = new javax.swing.JLabel();
        txtEmail = new javax.swing.JTextField();
        hrUsername3 = new javax.swing.JLabel();
        txtAnswer = new javax.swing.JTextField();
        hrUsername4 = new javax.swing.JLabel();
        SQbox = new javax.swing.JComboBox<>();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        mainPanel.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        Header.setBackground(new java.awt.Color(119, 136, 153));
        Header.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 36)); // NOI18N
        jLabel2.setText("Reset password");
        Header.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(190, 20, 300, -1));

        mainPanel.add(Header, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 640, 90));

        hrUsername.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        hrUsername.setText("Username :");
        mainPanel.add(hrUsername, new org.netbeans.lib.awtextra.AbsoluteConstraints(140, 130, 90, 20));

        hrPassword.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        hrPassword.setText("New Password :");
        mainPanel.add(hrPassword, new org.netbeans.lib.awtextra.AbsoluteConstraints(110, 370, 140, 20));

        txtUsername.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        txtUsername.setBorder(javax.swing.BorderFactory.createMatteBorder(1, 1, 1, 1, new java.awt.Color(153, 153, 153)));
        txtUsername.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtUsernameActionPerformed(evt);
            }
        });
        mainPanel.add(txtUsername, new org.netbeans.lib.awtextra.AbsoluteConstraints(220, 120, 300, 30));

        btnLogin1.setBackground(new java.awt.Color(119, 136, 154));
        btnLogin1.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        btnLogin1.setForeground(new java.awt.Color(255, 255, 255));
        btnLogin1.setText("Back");
        btnLogin1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLogin1ActionPerformed(evt);
            }
        });
        mainPanel.add(btnLogin1, new org.netbeans.lib.awtextra.AbsoluteConstraints(80, 430, 230, 40));

        txtPassword.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtPasswordActionPerformed(evt);
            }
        });
        mainPanel.add(txtPassword, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 370, 300, 30));

        btnLogin2.setBackground(new java.awt.Color(119, 136, 154));
        btnLogin2.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        btnLogin2.setForeground(new java.awt.Color(255, 255, 255));
        btnLogin2.setText("Reset");
        btnLogin2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnLogin2ActionPerformed(evt);
            }
        });
        mainPanel.add(btnLogin2, new org.netbeans.lib.awtextra.AbsoluteConstraints(340, 430, 230, 40));

        hrUsername1.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        hrUsername1.setText("Phone Number:");
        mainPanel.add(hrUsername1, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 170, 260, 20));

        txtPhone.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        txtPhone.setBorder(javax.swing.BorderFactory.createMatteBorder(1, 1, 1, 1, new java.awt.Color(153, 153, 153)));
        txtPhone.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtPhoneActionPerformed(evt);
            }
        });
        mainPanel.add(txtPhone, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 200, 230, 30));

        hrUsername2.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        hrUsername2.setText("Email:");
        mainPanel.add(hrUsername2, new org.netbeans.lib.awtextra.AbsoluteConstraints(350, 170, 260, 20));

        txtEmail.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        txtEmail.setBorder(javax.swing.BorderFactory.createMatteBorder(1, 1, 1, 1, new java.awt.Color(153, 153, 153)));
        txtEmail.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtEmailActionPerformed(evt);
            }
        });
        mainPanel.add(txtEmail, new org.netbeans.lib.awtextra.AbsoluteConstraints(350, 200, 260, 30));

        hrUsername3.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        hrUsername3.setText("Security Question:");
        mainPanel.add(hrUsername3, new org.netbeans.lib.awtextra.AbsoluteConstraints(100, 260, 130, 40));

        txtAnswer.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        txtAnswer.setBorder(javax.swing.BorderFactory.createMatteBorder(1, 1, 1, 1, new java.awt.Color(153, 153, 153)));
        txtAnswer.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtAnswerActionPerformed(evt);
            }
        });
        mainPanel.add(txtAnswer, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 320, 300, 30));

        hrUsername4.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        hrUsername4.setText("Answer:");
        mainPanel.add(hrUsername4, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 310, 260, 40));

        SQbox.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "What city were you born in?", "Where is your hometown?", "What is your favorite hobby", "What is the name of your first pet?", "What is your mother's name?", "What is your father's name?" }));
        mainPanel.add(SQbox, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 270, 300, -1));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(mainPanel, javax.swing.GroupLayout.PREFERRED_SIZE, 641, javax.swing.GroupLayout.PREFERRED_SIZE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addComponent(mainPanel, javax.swing.GroupLayout.PREFERRED_SIZE, 495, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void txtUsernameActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtUsernameActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtUsernameActionPerformed

    private void btnLogin1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLogin1ActionPerformed
 auth.LoginForm Login= new  auth.LoginForm();
        Login.setVisible(true);
        this.dispose();        
    }//GEN-LAST:event_btnLogin1ActionPerformed

    private void btnLogin2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLogin2ActionPerformed
        // TODO add your handling code here:
       String username = txtUsername.getText();
String phone = txtPhone.getText();
String email = txtEmail.getText();
String SQ = (String) SQbox.getSelectedItem();
String answer = txtAnswer.getText();
String newPassword = txtPassword.getText();

try (BufferedReader br = new BufferedReader(new FileReader("security.txt"))) {
    String line;
    while ((line = br.readLine()) != null) {
        String[] parts = line.split(",");
        if (parts[1].equals(username) && parts[2].equals(phone) && parts[3].equals(email) && parts[4].equals(SQ) && parts[5].equals(answer)) {
            String userId = parts[0]; // Retrieve the user ID from the security.txt file
            StringBuilder content = new StringBuilder(); // Declare content here
            try (BufferedReader br2 = new BufferedReader(new FileReader("usertxt.txt"))) {
                String line2;
                while ((line2 = br2.readLine()) != null) {
                    String[] parts2 = line2.split(",");
                    if (parts2[0].equals(userId)) {
                        parts2[2] = newPassword;
                        line2 = String.join(",", parts2);
                    }
                    content.append(line2).append("\n");
                }
                try (BufferedWriter bw = new BufferedWriter(new FileWriter("usertxt.txt"))) {
                    bw.write(content.toString());
                    JOptionPane.showMessageDialog(null, "Password reset successfully!");
                } catch (IOException e) {
                    JOptionPane.showMessageDialog(null, "Error writing to usertxt.txt: " + e.getMessage());
                }
            }
            return;
        }
    }
    JOptionPane.showMessageDialog(null, "Security question does not match. Please try again.");
} catch (IOException e) {
    JOptionPane.showMessageDialog(null, "Error reading from security.txt: " + e.getMessage());
}
    }//GEN-LAST:event_btnLogin2ActionPerformed

    private void txtPhoneActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtPhoneActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtPhoneActionPerformed

    private void txtEmailActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtEmailActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtEmailActionPerformed

    private void txtAnswerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtAnswerActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtAnswerActionPerformed

    private void txtPasswordActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtPasswordActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtPasswordActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(Reset.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(Reset.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(Reset.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(Reset.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>

        java.awt.EventQueue.invokeLater(new Runnable() {
        public void run() {
            new Reset().setVisible(true);
        }
    });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel Header;
    private javax.swing.JComboBox<String> SQbox;
    private javax.swing.JButton btnLogin1;
    private javax.swing.JButton btnLogin2;
    private javax.swing.JLabel hrPassword;
    private javax.swing.JLabel hrUsername;
    private javax.swing.JLabel hrUsername1;
    private javax.swing.JLabel hrUsername2;
    private javax.swing.JLabel hrUsername3;
    private javax.swing.JLabel hrUsername4;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel mainPanel;
    private javax.swing.JTextField txtAnswer;
    private javax.swing.JTextField txtEmail;
    private javax.swing.JTextField txtPassword;
    private javax.swing.JTextField txtPhone;
    private javax.swing.JTextField txtUsername;
    // End of variables declaration//GEN-END:variables
}
